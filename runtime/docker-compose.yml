# Claude Code Sandbox (Lite) Container
#
# Usage:
#   Option 1: Use the convenience script (recommended)
#     ./start-sandbox.sh
#
#   Option 2: Manual commands
#     docker compose up -d                              # Start container
#     docker compose exec -u node claude-code zsh      # Enter shell as node user
#     docker compose down                               # Stop container
#
# Note: Container uses dynamic UID/GID mapping via entrypoint script
# Note: docker compose exec defaults to root, so -u node is required for CLI commands

services:
  claude-code:
    image: ccsandbox-node-py:latest
    working_dir: /workspace
    stdin_open: true
    tty: true

    volumes:
      - ./:/workspace:delegated
      - bashhistory:/commandhistory
      - config:/home/node/.claude
      - ghconfig:/home/node/.config/gh
      # Mount AWS credentials if using Bedrock (read-only)
      - ${HOME}/.aws:/home/node/.aws:ro,cached

    # Load API configuration from .env file ONLY (prevents host env leakage)
    env_file:
      - .env

    environment:
      # Container settings (not from .env)
      NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings"
      CLAUDE_CONFIG_DIR: "/home/node/.claude"
      POWERLEVEL9K_DISABLE_GITSTATUS: "true"
      # Host UID/GID for dynamic user mapping (set by start-sandbox.sh)
      HOST_UID: "${HOST_UID:-1000}"
      HOST_GID: "${HOST_GID:-1000}"

    command: >
      bash -c "
        gh auth setup-git 2>/dev/null || true &&
        exec zsh
      "

volumes:
  bashhistory:
    name: ${COMPOSE_PROJECT_NAME}_bashhistory
  config:
    name: ${COMPOSE_PROJECT_NAME}_config
  ghconfig:
    name: ${COMPOSE_PROJECT_NAME}_ghconfig
